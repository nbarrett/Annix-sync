import { MigrationInterface, QueryRunner } from "typeorm";

export class CorrectAstmA106GradeBData1762267850000 implements MigrationInterface {
    name = 'CorrectAstmA106GradeBData1762267850000';

    public async up(queryRunner: QueryRunner): Promise<void> {
        console.log('üîß Correcting ASTM A106 Grade B pipe data...');

        // Get ASTM A106 Grade B steel specification ID
        const astmA106BResult = await queryRunner.query(`
            SELECT id FROM steel_specifications WHERE steel_spec_name = 'ASTM A106 Grade B'
        `);
        
        if (!astmA106BResult.length) {
            console.error('ASTM A106 Grade B steel specification not found');
            return;
        }
        
        const steelSpecId = astmA106BResult[0].id;

        // First, delete all existing ASTM A106 Grade B pipe dimensions to avoid conflicts
        await queryRunner.query(`
            DELETE FROM pipe_dimensions 
            WHERE steel_specification_id = ${steelSpecId}
        `);

        console.log('üóëÔ∏è  Removed existing ASTM A106 Grade B data');

        // Complete ASTM A106 Grade B data from specification
        // [nominalBore, outsideDiameter, wallThickness, internalDiameter, massPerMeter, schedule]
        const astmA106Data = [
            [6, 10.3, 1.73, 6.85, 0.36, '40'],
            [6, 10.3, 2.41, 5.47, 0.46, '80'],
            [8, 13.7, 2.24, 9.23, 0.63, '40'],
            [8, 13.7, 3.02, 7.65, 0.80, '80'],
            [10, 17.1, 2.31, 12.48, 0.85, '40'],
            [10, 17.1, 3.20, 10.70, 1.10, '80'],
            [15, 21.3, 2.77, 15.76, 1.27, '40'],
            [15, 21.3, 3.73, 13.83, 1.62, '80'],
            [15, 21.3, 4.78, 11.75, 1.94, '160'],
            [15, 21.3, 7.47, 6.36, 2.56, 'XXS'],
            [20, 26.7, 2.87, 20.96, 1.68, '40'],
            [20, 26.7, 3.91, 18.88, 2.19, '80'],
            [20, 26.7, 5.56, 15.57, 2.89, '160'],
            [20, 26.7, 7.82, 11.05, 3.64, 'XXS'],
            [25, 33.4, 3.38, 26.64, 2.50, '40'],
            [25, 33.4, 4.55, 24.31, 3.23, '80'],
            [25, 33.4, 6.35, 20.70, 4.23, '160'],
            [25, 33.4, 9.09, 15.21, 5.45, 'XXS'],
            [32, 42.2, 3.56, 35.09, 3.38, '40'],
            [32, 42.2, 4.85, 32.50, 4.46, '80'],
            [32, 42.2, 6.35, 29.50, 5.61, '160'],
            [32, 42.2, 9.70, 22.79, 7.74, 'XXS'],
            [40, 48.3, 3.68, 40.93, 4.05, '40'],
            [40, 48.3, 5.08, 38.14, 5.40, '80'],
            [40, 48.3, 7.14, 34.02, 7.22, '160'],
            [40, 48.3, 10.16, 27.98, 9.55, 'XXS'],
            [50, 60.3, 3.91, 52.48, 5.43, '40'],
            [50, 60.3, 5.54, 49.22, 7.43, '80'],
            [50, 60.3, 8.74, 42.82, 11.09, '160'],
            [50, 60.3, 11.07, 38.16, 13.45, 'XXS'],
            [65, 73.0, 5.16, 62.68, 8.62, '40'],
            [65, 73.0, 7.01, 58.98, 11.40, '80'],
            [65, 73.0, 9.53, 53.94, 14.90, '160'],
            [65, 73.0, 14.02, 44.96, 20.38, 'XXS'],
            [80, 88.9, 5.49, 77.92, 11.29, '40'],
            [80, 88.9, 7.62, 73.66, 15.25, '80'],
            [80, 88.9, 11.13, 66.64, 21.33, '160'],
            [80, 88.9, 15.24, 58.42, 27.66, 'XXS'],
            [90, 101.6, 5.74, 90.12, 13.57, '40'],
            [90, 101.6, 8.08, 85.44, 18.62, '80'],
            [100, 114.3, 6.02, 102.26, 16.07, '40'],
            [100, 114.3, 8.56, 97.18, 22.31, '80'],
            [100, 114.3, 11.13, 92.04, 28.25, '120'],
            [100, 114.3, 13.49, 87.32, 33.49, '160'],
            [100, 114.3, 17.12, 80.06, 40.98, 'XXS'],
            [125, 141.3, 6.55, 128.20, 21.78, '40'],
            [125, 141.3, 9.53, 122.24, 30.92, '80'],
            [125, 141.3, 12.70, 115.90, 40.24, '120'],
            [125, 141.3, 15.88, 109.54, 49.05, '160'],
            [125, 141.3, 19.05, 103.20, 57.38, 'XXS'],
            [150, 168.3, 7.11, 154.08, 28.26, '40'],
            [150, 168.3, 10.97, 146.36, 42.56, '80'],
            [150, 168.3, 14.27, 139.76, 54.17, '120'],
            [150, 168.3, 18.26, 131.78, 67.49, '160'],
            [150, 168.3, 21.95, 124.40, 79.10, 'XXS'],
            [200, 219.1, 6.35, 206.40, 33.31, '20'],
            [200, 219.1, 7.04, 205.02, 36.79, '30'],
            [200, 219.1, 8.18, 202.74, 42.53, '40'],
            [200, 219.1, 10.31, 198.48, 53.10, '60'],
            [200, 219.1, 12.70, 193.70, 64.63, '80'],
            [200, 219.1, 15.09, 188.92, 75.82, '100'],
            [200, 219.1, 18.26, 182.58, 90.36, '120'],
            [200, 219.1, 20.62, 177.86, 100.86, '140'],
            [200, 219.1, 22.23, 174.64, 107.78, 'XXS'],
            [200, 219.1, 23.01, 173.08, 111.16, '160'],
            [250, 273.0, 6.35, 260.30, 41.77, '20'],
            [250, 273.0, 7.80, 257.40, 51.00, '30'],
            [250, 273.0, 9.27, 254.46, 60.29, '40'],
            [250, 273.0, 12.70, 247.60, 81.54, '60'],
            [250, 273.0, 15.09, 242.82, 95.90, '80'],
            [250, 273.0, 18.26, 236.48, 114.64, '100'],
            [250, 273.0, 21.44, 230.12, 132.88, '120'],
            [250, 273.0, 25.40, 222.20, 154.96, '140'],
            [250, 273.0, 28.58, 215.84, 172.09, '160'],
            [300, 323.8, 6.35, 311.10, 49.72, '20'],
            [300, 323.8, 8.38, 307.04, 65.20, '30'],
            [300, 323.8, 9.52, 304.76, 73.82, '40'],
            [300, 323.8, 10.31, 303.18, 79.72, '40'],
            [300, 323.8, 12.70, 298.40, 97.44, '60'],
            [300, 323.8, 14.27, 295.26, 108.86, '60'],
            [300, 323.8, 17.48, 288.84, 131.89, '80'],
            [300, 323.8, 21.44, 280.92, 159.72, '100'],
            [300, 323.8, 25.40, 273.00, 186.75, '120'],
            [300, 323.8, 28.58, 266.64, 207.85, '140'],
            [300, 323.8, 33.32, 257.16, 238.52, '160'],
            [350, 355.6, 6.35, 342.90, 54.68, '10'],
            [350, 355.6, 7.92, 339.76, 67.94, '20'],
            [350, 355.6, 9.52, 336.56, 81.28, '30'],
            [350, 355.6, 11.13, 333.34, 94.40, '40'],
            [350, 355.6, 12.70, 330.20, 107.38, '60'],
            [350, 355.6, 15.09, 325.42, 126.58, '60'],
            [350, 355.6, 19.05, 317.50, 157.95, '80'],
            [350, 355.6, 23.82, 307.96, 194.82, '100'],
            [350, 355.6, 27.79, 300.02, 224.42, '120'],
            [350, 355.6, 31.75, 292.10, 253.14, '140'],
            [350, 355.6, 35.71, 284.18, 281.38, '160'],
            [400, 406.4, 6.35, 392.70, 62.63, '10'],
            [400, 406.4, 7.92, 390.56, 77.86, '20'],
            [400, 406.4, 9.52, 387.36, 93.21, '30'],
            [400, 406.4, 12.70, 381.00, 123.29, '40'],
            [400, 406.4, 16.66, 373.08, 160.05, '60'],
            [400, 406.4, 21.44, 363.52, 203.32, '80'],
            [400, 406.4, 26.19, 354.02, 245.32, '100'],
            [400, 406.4, 30.96, 344.48, 286.44, '120'],
            [400, 406.4, 36.52, 333.36, 332.62, '140'],
            [400, 406.4, 40.49, 325.42, 364.85, '160'],
            [450, 457.2, 6.35, 444.50, 70.59, '10'],
            [450, 457.2, 7.92, 441.36, 87.79, '20'],
            [450, 457.2, 9.52, 438.16, 105.14, '30'],
            [450, 457.2, 11.13, 434.94, 122.36, '30'],
            [450, 457.2, 12.70, 431.80, 139.19, '40'],
            [450, 457.2, 14.27, 428.66, 155.91, '40'],
            [450, 457.2, 19.05, 419.10, 205.62, '60'],
            [450, 457.2, 23.83, 409.54, 254.38, '80'],
            [450, 457.2, 29.36, 398.48, 309.44, '100'],
            [450, 457.2, 34.92, 387.36, 363.19, '120'],
            [450, 457.2, 39.69, 377.82, 408.01, '140'],
            [450, 457.2, 45.24, 366.72, 459.18, '160'],
            [500, 508.0, 6.35, 495.30, 78.54, '10'],
            [500, 508.0, 9.52, 488.96, 117.07, '20'],
            [500, 508.0, 12.70, 482.60, 155.10, '30'],
            [500, 508.0, 15.09, 477.82, 183.15, '40'],
            [500, 508.0, 20.63, 466.74, 247.78, '60'],
            [500, 508.0, 26.19, 455.62, 310.82, '80'],
            [500, 508.0, 32.54, 442.92, 381.04, '100'],
            [500, 508.0, 38.10, 431.80, 440.93, '120'],
            [500, 508.0, 44.45, 419.10, 507.54, '140'],
            [500, 508.0, 50.01, 407.98, 564.14, '160'],
            [550, 558.8, 6.35, 546.10, 86.50, '10'],
            [550, 558.8, 9.52, 539.76, 129.01, '20'],
            [550, 558.8, 12.70, 533.40, 171.01, '30'],
            [550, 558.8, 22.23, 514.34, 293.81, '60'],
            [550, 558.8, 28.58, 501.64, 373.28, '80'],
            [600, 609.6, 6.35, 596.90, 94.45, '10'],
            [600, 609.6, 9.52, 590.56, 140.94, '20'],
            [600, 609.6, 12.70, 584.20, 186.92, '30'],
            [600, 609.6, 14.27, 581.06, 209.54, '30'],
            [600, 609.6, 17.48, 574.64, 254.93, '40'],
            [600, 609.6, 24.61, 560.38, 354.74, '60'],
            [600, 609.6, 30.96, 547.68, 441.90, '80'],
            [600, 609.6, 38.89, 531.82, 546.92, '100'],
            [600, 609.6, 46.02, 517.56, 639.18, '120'],
            [600, 609.6, 52.39, 504.82, 718.94, '140'],
            [600, 609.6, 59.34, 490.52, 806.61, '160']
        ];

        // Insert nominal outside diameters if they don't exist
        for (const [nominalBore, outsideDiameter] of astmA106Data) {
            await queryRunner.query(`
                INSERT INTO nominal_outside_diameters (nominal_diameter_mm, outside_diameter_mm)
                VALUES (${nominalBore}, ${outsideDiameter})
                ON CONFLICT (nominal_diameter_mm, outside_diameter_mm) DO NOTHING
            `);
        }

        console.log('üìè Ensured all nominal outside diameters exist');

        // Insert pipe dimensions
        for (const [nominalBore, outsideDiameter, wallThickness, internalDiameter, massPerMeter, schedule] of astmA106Data) {
            const nominalResult = await queryRunner.query(`
                SELECT id FROM nominal_outside_diameters 
                WHERE nominal_diameter_mm = ${nominalBore} AND outside_diameter_mm = ${outsideDiameter}
            `);
            
            if (nominalResult.length > 0) {
                const nominalId = nominalResult[0].id;
                const scheduleStr = String(schedule);
                const scheduleNumber = /^\d+$/.test(scheduleStr) ? parseFloat(scheduleStr) : null;
                
                await queryRunner.query(`
                    INSERT INTO pipe_dimensions (
                        wall_thickness_mm,
                        internal_diameter_mm,
                        mass_kgm,
                        schedule_designation,
                        schedule_number,
                        nominal_outside_diameter_id,
                        steel_specification_id
                    ) VALUES (
                        ${wallThickness},
                        ${internalDiameter},
                        ${massPerMeter},
                        '${schedule}',
                        ${scheduleNumber},
                        ${nominalId},
                        ${steelSpecId}
                    )
                `);
            }
        }

        console.log(`‚úÖ Inserted complete ASTM A106 Grade B pipe data (${astmA106Data.length} entries)`);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        // Get ASTM A106 Grade B steel specification ID
        const astmA106BResult = await queryRunner.query(`
            SELECT id FROM steel_specifications WHERE steel_spec_name = 'ASTM A106 Grade B'
        `);
        
        if (astmA106BResult.length > 0) {
            const steelSpecId = astmA106BResult[0].id;
            
            // Remove all ASTM A106 Grade B pipe dimensions
            await queryRunner.query(`
                DELETE FROM pipe_dimensions 
                WHERE steel_specification_id = ${steelSpecId}
            `);
            
            console.log('üóëÔ∏è  Removed ASTM A106 Grade B pipe data');
        }
    }
}